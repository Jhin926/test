<html lang="en"><head>
    <meta charset="utf-8">
    <!--<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">-->
    <title>邮件情</title>
    <link rel="stylesheet" href="css/common.css">
</head>
<body>
<div id="container">
    <header id="header">
        <h1 id="email-title" class="email-header">1003596人已经加入严选【新格调生活】，快来加入吧！（限时送￥39无痕立体记忆绵眼罩）</h1>
        <div class="remark-cont" id="remark-cont">
        </div>
    </header>
    <article id="content">
        <section class="sender">
            <div class="sender-info">
                <p class="sender-img" id="sender-img" style="background-image: url(&quot;./img/gray_block.png&quot;); color: rgb(255, 255, 255);">y</p>
                <div class="">
                    <p class="sender-name" id="sender-name"></p>
                    <div class="sender-handle">
                        <p class="sender-eml" id="sender-eml">yanxuan2@service.netease.com</p>
                        <p class="sender-encl enclosure">
                            <span><a href="#footer"><img src="img/2.png" width="15" height="15" alt=""></a></span>
                            <span class="sender-encl-text" id="sender-encl-text"></span>
                        </p>
                        <p class="btn-detail" id="btn-detail">详情</p>
                    </div>
                </div>
                <div class="clear"></div>
            </div>
            <div class="sender-detail" id="sender-detail">
                <ul>
                    <li>
                        <dl>
                            <dt>发件人</dt>
                            <dd id="sender">
                                <div class="user-list">
                                    <p class="user-name"></p>
                                    <p class="user-email">yanxuan2@service.netease.com</p>
                                </div>
                            </dd>
                        </dl>
                    </li><li>
                    <dl>
                        <dt>收件人</dt>
                        <dd id="addr"><div class="user-list"><p class="user-name"></p><p class="user-email">user@netease.com</p></div></dd>
                    </dl>
                </li><li class="traces-list">
                    <dl>
                        <dt>抄送</dt>
                        <dd id="traces">
                        </dd>
                    </dl>
                </li><li>
                    <dl>
                        <dt>时间</dt>
                        <dd>
                            <div class="user-list">
                                <p class="user-email" id="send-time">2016-10-11 06:22:33</p>
                            </div>
                        </dd>
                    </dl>
                </li><li class="enclosure">
                    <dl>
                        <dt>附件</dt>
                        <dd>
                            <p class="sender-encl">
                                <span><a href="#footer"><img src="img/2.png" width="15" height="15" alt=""></a></span>
                                <span class="sender-encl-text"></span>
                            </p>
                        </dd>
                    </dl>
                </li>
                </ul>
            </div>
        </section>
        <section class="email-detail" id="email-content">&#65279;
            <div id="email-content-inner" class="email-detail-inner">
            <meta charset="UTF-8">
            <table align="center" style="font-family:Microsoft YaHei,Simsun;width:700px;table-layout:fixed;"
                   bgcolor="#ffffff" cellpadding="0" cellspacing="0">
                <tbody>
                <tr>
                    <td style="display:none;">网易自营生活类电商，一线品牌制造商直供</td>
                </tr>
                <tr>
                    <td>
                        <table style="width:700px;" border="0" cellpadding="0" cellspacing="0">
                            <tbody>
                            <tr>
                                <td style="width:700px;height:20px;font-family:Microsoft YaHei,Simsun;background:#ffffff;">
                                    <img src="http://mimg.127.net/hz/uploader/20161009/14760117165491074.jpeg"
                                         style="display:block;border:0;"></td>
                            </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>
                        <table style="width:700px;" border="0" cellpadding="0" cellspacing="0">
                            <tbody>
                            <tr>
                                <td style="width:700px;height:101px;font-family:Microsoft YaHei,Simsun;background:#ffffff;">
                                    <a style="display: block;"
                                       href="http://count.mail.163.com/statistics/w84Wmc.do?product=edm_60539851&amp;domain=email&amp;uid=&amp;area=1"
                                       target="_blank"><img
                                            src="http://mimg.127.net/hz/uploader/20161009/14760117165561075.jpeg"
                                            style="display:block;border:0;"></a></td>
                            </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>
                        <table style="width:700px;" border="0" cellpadding="0" cellspacing="0">
                            <tbody>
                            <tr>
                                <td style="width:700px;height:239px;font-family:Microsoft YaHei,Simsun;background:#f6f1ed;">
                                    <a style="display: block;"
                                       href="http://count.mail.163.com/statistics/W7zNkq.do?product=edm_60539851&amp;domain=email&amp;uid=&amp;area=2"
                                       target="_blank"><img
                                            src="http://mimg.127.net/hz/uploader/20161009/14760117165631076.jpeg"
                                            style="display:block;border:0;"></a></td>
                            </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>
                        <table style="width:700px;" border="0" cellpadding="0" cellspacing="0">
                            <tbody>
                            <tr>
                                <td style="width:700px;height:340px;font-family:Microsoft YaHei,Simsun;background:#f0ebe7;">
                                    <a style="display: block;"
                                       href="http://count.mail.163.com/statistics/O5iNqj.do?product=edm_60539851&amp;domain=email&amp;uid=&amp;area=3"
                                       target="_blank"><img
                                            src="http://mimg.127.net/hz/uploader/20161009/14760117165711077.jpeg"
                                            style="display:block;border:0;"></a></td>
                            </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>
                        <table style="width:700px;" border="0" cellpadding="0" cellspacing="0">
                            <tbody>
                            <tr>
                                <td style="width:700px;height:76px;font-family:Microsoft YaHei,Simsun;background:#b3aca6;">
                                    <img src="http://mimg.127.net/hz/uploader/20161009/14760117165801078.jpeg"
                                         style="display:block;border:0;"></td>
                            </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>
                        <table style="width:700px;" border="0" cellpadding="0" cellspacing="0">
                            <tbody>
                            <tr>
                                <td style="width:350px;height:458px;font-family:Microsoft YaHei,Simsun;background:#ffffff;">
                                    <a style="display: block;"
                                       href="http://count.mail.163.com/statistics/nnNkks.do?product=edm_60539851&amp;domain=email&amp;uid=&amp;area=4"
                                       target="_blank"><img
                                            src="http://mimg.127.net/hz/uploader/20161009/14760117165861079.jpeg"
                                            style="display:block;border:0;"></a></td>
                                <td style="width:350px;height:458px;font-family:Microsoft YaHei,Simsun;background:#ffffff;">
                                    <a style="display: block;"
                                       href="http://count.mail.163.com/statistics/9dsisc.do?product=edm_60539851&amp;domain=email&amp;uid=&amp;area=5"
                                       target="_blank"><img
                                            src="http://mimg.127.net/hz/uploader/20161009/14760117165941080.jpeg"
                                            style="display:block;border:0;"></a></td>
                            </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>
                        <table style="width:700px;" border="0" cellpadding="0" cellspacing="0">
                            <tbody>
                            <tr>
                                <td style="width:349px;height:466px;font-family:Microsoft YaHei,Simsun;background:#ffffff;">
                                    <a style="display: block;"
                                       href="http://count.mail.163.com/statistics/zOccAS.do?product=edm_60539851&amp;domain=email&amp;uid=&amp;area=6"
                                       target="_blank"><img
                                            src="http://mimg.127.net/hz/uploader/20161009/14760117166071081.jpeg"
                                            style="display:block;border:0;"></a></td>
                                <td style="width:351px;height:466px;font-family:Microsoft YaHei,Simsun;background:#ffffff;">
                                    <a style="display: block;"
                                       href="http://count.mail.163.com/statistics/7nhA4W.do?product=edm_60539851&amp;domain=email&amp;uid=&amp;area=7"
                                       target="_blank"><img
                                            src="http://mimg.127.net/hz/uploader/20161009/14760117166161082.jpeg"
                                            style="display:block;border:0;"></a></td>
                            </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>
                        <table style="width:700px;" border="0" cellpadding="0" cellspacing="0">
                            <tbody>
                            <tr>
                                <td style="width:700px;height:326px;font-family:Microsoft YaHei,Simsun;background:#ffffff;">
                                    <a style="display: block;"
                                       href="http://count.mail.163.com/statistics/w84Wmc.do?product=edm_60539851&amp;domain=email&amp;uid=&amp;area=8"
                                       target="_blank"><img
                                            src="http://mimg.127.net/hz/uploader/20161009/14760117166241083.jpeg"
                                            style="display:block;border:0;"></a></td>
                            </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>
                        <table style="width:700px;" border="0" cellpadding="0" cellspacing="0">
                            <tbody>
                            <tr></tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                </tbody>
            </table>
            <img src="http://count.mail.163.com/beacon/edm.gif?no=60539851&amp;domain=email&amp;date=20161011&amp;uid="
                 style="display:none">
            <div class="dm-unsub-div">
                <div style="text-align:center;padding-top:15px;font-size:10px;color:#777">如果你不想再收到该产品的推荐邮件，请点击 <a
                        style="font-size:10px"
                        href="http://dm.mail.163.com/anonymous/adsubscribe/unsubscribe?depId=1&amp;proId=11301207&amp;mitId=60539851&amp;sec=fDRJppjl7tb6N1trjdx4fuIZFbzVURQS"
                        hidefocus="true">这里退订</a></div>
            </div>
            </div>
        </section>
    </article>
    <footer id="footer">
    </footer>
</div>
<script>
    var factWidth = document.querySelector('#email-content-inner').offsetWidth;
    var contentWidth = document.querySelector('#email-content').offsetWidth;
    var scaleVal = contentWidth/factWidth;
        document.querySelector('#email-content-inner').style.transform="scale("+(scaleVal-0.05)+","+(scaleVal-0.05)+")";
        document.querySelector('#email-content-inner').style.transformOrigin="0 0";

    function setupWebViewJavascriptBridge(callback) {
        if (window.WebViewJavascriptBridge) { return callback(WebViewJavascriptBridge); }
        if (window.WVJBCallbacks) { return window.WVJBCallbacks.push(callback); }
        window.WVJBCallbacks = [callback];
        var WVJBIframe = document.createElement('iframe');
        WVJBIframe.style.display = 'none';
        WVJBIframe.src = 'wvjbscheme://__BRIDGE_LOADED__';
        document.documentElement.appendChild(WVJBIframe);
        setTimeout(function() { document.documentElement.removeChild(WVJBIframe) }, 0)
    }

    document.getElementById('btn-detail').addEventListener('click', function () {
        var getDetail = document.getElementById('sender-detail');
        if (getDetail.clientHeight > 0) {
            getDetail.style.height = '0px';
            getDetail.style.padding = '0px';
            this.innerHTML = '详情';
        } else {
            getDetail.style.height = '';
            getDetail.style.padding = '';
            this.innerHTML = '隐藏';
        }
    }, false);

    function toggleHandle(_this) {
        var getAllHandle =document.querySelectorAll('.doc-handle');
        var thisHandle = _this.nextElementSibling;

        for(var i=0;i<getAllHandle.length;i++){
            if(getAllHandle[i] === thisHandle){
                if (thisHandle.style.display == 'block') {
                    thisHandle.style.display = 'none';
                    break;
                } else {
                    thisHandle.style.display = 'block';
                }
            }else  getAllHandle[i].style.display='none';
        }
    }

    var getInfo = location.search;
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange=function(){
        if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
            var data = JSON.parse(xmlhttp.responseText).data;
            console.log(data);
            document.getElementById('email-title').innerHTML = data.subject;//邮件主题

            var getTagsCont = document.getElementById('remark-cont');//标签列表
            var tags = data.tags;
            for(var i =0;i<tags.length;i++){
                var tag = document.createElement('span');
                tag.innerHTML = tags[i].name;
                getTagsCont.appendChild(tag);
            }

            //发件人前面的色块的背景图片
            var img = document.getElementById('sender-img');
            var getStatus = data.visitingCard.status;
            var getName = (data.froms[0].name || data.froms[0].value).substring(0,1);
            if(getStatus == 1 || getStatus==2){
                img.style.backgroundImage = 'url(./img/gray_block.png)';
                img.style.color = 'rgb(255,255,255)';
                img.innerText = getName;
            }else if(getStatus == 3 || getStatus==4){
                img.style.backgroundImage = 'url(./img/blue_block.png)';
                img.style.color = 'rgb(255,255,255)';
                img.innerText = getName;
            }else if(getStatus == 5 || getStatus==6){
                img.style.backgroundImage = 'url(./img/blue.png)';
                img.innerText = getName;
            }else if(getStatus == 7 || getStatus==8){
                img.style.backgroundImage = 'url(./img/gray.png)';
                img.innerText = getName;
            }else {
                console.error('未知的visitingCard.status值');
                img.style.backgroundImage = 'url(./img/gray.png)';
                img.innerText = getName;
            }
            document.querySelector('#sender-name').innerHTML = data.froms[0].name || '';
            document.querySelector('#sender-eml').innerHTML = data.froms[0].value || '';
            //附件
            var getAtt = data.attachments;
            if(getAtt.length>0){//有附件的情况
                var getEncl = document.querySelectorAll('.enclosure');
                for(var i=0;i<getEncl.length;i++){
                    getEncl[i].style.display= 'block';
                }
                var getAttCont = document.querySelectorAll('.sender-encl-text');
                for(var i = 0;i<getAttCont.length;i++){
                    getAttCont[i].style.display='block';
                    getAttCont[i].innerHTML = 'X' + data.attachments.length;
                }

                for(var i =0;i<getAtt.length;i++){
                    var docContent = document.createElement('section');
                    docContent.className = 'doc-content';

                    var getType = getAtt[i].contentType;
                    var imgSrc = '';
                    if(getType==1){
                        imgSrc = './img/icon_baojiadan.png';
                    }else if(getType==2){
                        imgSrc = './img/icon_excel.png';
                    }else if(getType==3){
                        imgSrc = './img/icon_html.png';
                    }else if(getType==4){
                        imgSrc = './img/icon_pi.png';
                    }else if(getType==5){
                        imgSrc = './img/icon_pic.png';
                    }else if(getType==6){
                        imgSrc = './img/icon_ppt.png';
                    }else if(getType==7){
                        imgSrc = './img/icon_product.png';
                    }else if(getType==8){
                        imgSrc = './img/icon_txt.png';
                    }else if(getType==9){
                        imgSrc = './img/icon_word.png';
                    }else if(getType==10){
                        imgSrc = './img/icon_yasuo.png';
                    }else if(getType==11){
                        imgSrc = './img/icon_yjsound.png';
                    }else{
                        console.warn('未知的文件类型');
                        imgSrc = './img/icon_txt.png';
                    }

                    var attach = '<p class="doc-img"><img src="'+imgSrc+'" alt="" /></p>\
                <p class="doc-name">'+getAtt[i].name+'</p><p class="doc-size">('+ getAtt[i].size%1024 +'KB)</p>\
                <div class="doc-handle-cont"><span class="btn-doc" onclick="toggleHandle(this)">&bull;&bull;&bull;</span>\
                <ul class="doc-handle"><li data-contenttype="'+ getAtt[i].content_type +'" data-size="'+ getAtt[i].size +'" data-link="'+ getAtt[i].value +'" data-name="'+ getAtt[i].name +'">邮件发送</li><li data-contenttype="'+ getAtt[i].content_type +'" data-size="'+ getAtt[i].size +'" data-link="'+ getAtt[i].value +'" data-name="'+ getAtt[i].name +'">下载附件</li></ul></div><div class="clear"></div>';
                    docContent.innerHTML = attach;
                    document.getElementById('footer').appendChild(docContent);
                }

                function getData(_parm){
                    var reg = new RegExp("(^|&)"+_parm+"=([^&]*)(&|$)","i");
                    var r =window.location.search.substr(1).match(reg);
                    if(r!=null) return unescape(r[2]);
                    return null;
                }

                setupWebViewJavascriptBridge(function(bridge) {
                    var getId = JSON.parse(getData('data')).id;
                    var uls = document.getElementsByClassName('doc-handle');
                    for(var j =0;j<uls.length;j++){
                        uls[j].getElementsByTagName('li')[0].onclick = function (e){
                            //alert(123);
                            e.preventDefault;
                            var data = {
                                name: this.getAttribute('data-name'),
                                link: this.getAttribute('data-link'),
                                size: this.getAttribute('data-size'),
                                contentType: this.getAttribute('data-contenttype'),
                                id: getId
                            };
                            bridge.callHandler('sendEmail', data, function(response){
                                //alert(response);
                            })
                        }

                        uls[j].getElementsByTagName('li')[1].onclick = function (e){
                            //alert(456);
                            e.preventDefault;
                            var data = {
                                name: this.getAttribute('data-name'),
                                link: this.getAttribute('data-link'),
                                size: this.getAttribute('data-size'),
                                contentType: this.getAttribute('data-contenttype'),
                                id: getId
                            };

                            bridge.callHandler('loadAttachment', data, function(response) {
                                //alert(response);
                            })
                        }
                    }

                })
            }
            document.querySelector('#sender').getElementsByClassName('user-name')[0].innerHTML = data.froms[0].name || '';
            document.querySelector('#sender').getElementsByClassName('user-email')[0].innerHTML = data.froms[0].value || '';
            document.querySelector('#send-time').innerHTML = data.sendTime.substring(0,data.sendTime.length-2);


            //收件人列表
            var addrs = data.tos;
            var addrList = '';
            if(addrs.length>0){
                for(var i =0;i<addrs.length;i++){
                    var addr = '<div class="user-list"><p class="user-name">'+ (addrs[i].name || '') +'</p><p class="user-email">'+ (addrs[i].value || '默认邮箱') +'</p></div>';
                    addrList+= addr;
                }
                document.querySelector('#addr').innerHTML = addrList;
            }

            //抄送人列表
            var traces = data.traceRecords;
            var traList = '';
            if(traces.length>0){
                document.querySelector('.traces-list').style.display='block';
                for(var i =0;i<traces.length;i++){
                    var tra = '<div class="user-list"><p class="user-name">'+ (traces[i].name || '') +'</p><p class="user-email">'+ (traces[i].value || '默认邮箱') +'</p></div>';
                    traList+= tra;
                }
                document.querySelector('#traces').innerHTML = traList;
            }

            document.querySelector('#email-content').innerHTML = data.content;


        }
    }
    xmlhttp.open('get', '/api/email/v1/detail'+getInfo, true);
    xmlhttp.send();

</script>


</body></html>